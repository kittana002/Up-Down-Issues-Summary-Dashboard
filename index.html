<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Up/Down Issues Summary Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Slate & Amber -->
    <!-- Application Structure Plan: ผมได้ออกแบบแอปพลิเคชันเป็นแดชบอร์ดหน้าเดียว โดยแบ่งโครงสร้างเป็น 3 ส่วนหลัก: 1. สรุปภาพรวม (Key Metrics) แสดงตัวเลขที่สำคัญที่สุด, 2. กราฟแสดงแนวโน้ม (Charts) เพื่อให้เห็นการเปลี่ยนแปลงและสัดส่วนของปัญหา, และ 3. รายละเอียดเคส (Detailed Lists) ที่สามารถค้นหาและกรองข้อมูลได้ การออกแบบนี้ช่วยให้ผู้ใช้เห็นภาพรวมก่อน แล้วจึงเจาะลึกลงไปในรายละเอียดที่สนใจได้ตามต้องการ ซึ่งแก้ปัญหาข้อมูลกระจัดกระจายและช่วยให้เข้าใจสถานการณ์ได้ง่ายและรวดเร็ว -->
    <!-- Visualization & Content Choices: 1. Key Metrics: (Goal: Inform) ใช้การ์ดแสดงตัวเลขสรุปเพื่อให้ข้อมูลสำคัญโดดเด่นและเข้าใจง่าย. 2. Daily Incidents Chart: (Goal: Change/Compare) ใช้กราฟแท่งแบบซ้อน (Stacked Bar Chart) จาก Chart.js เพื่อแสดงแนวโน้มจำนวนเคสรายวันและเปรียบเทียบสัดส่วนระหว่างปัญหา Main Link และ Backup 4G ได้ในกราฟเดียว. 3. Problem Share Chart: (Goal: Compare) ใช้กราฟโดนัท (Doughnut Chart) จาก Chart.js เพื่อแสดงสัดส่วนของร้านค้าที่ได้รับผลกระทบระหว่างสองปัญหาหลัก. 4. Incident Lists: (Goal: Organize/Inform) ใช้รายการแบบการ์ดที่สร้างด้วย HTML/Tailwind และจัดการด้วย JavaScript เพื่อแสดงรายละเอียดแต่ละเคสอย่างเป็นระเบียบ พร้อมฟังก์ชันค้นหาเพื่อกรองข้อมูลตามชื่อหรือรหัสร้านค้า ทำให้เข้าถึงข้อมูลที่ต้องการได้ทันที -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 350px; max-height: 50vh; }
        .tab-button.active { border-color: #f59e0b; color: #f59e0b; background-color: #fffbeb; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .card-enter { animation: card-enter 0.5s ease-out forwards; }
        @keyframes card-enter {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Up/Down Issues Summary Dashboard</h1>
            <p class="text-slate-500 mt-2">ข้อมูลสรุปเคส "UP/Down บ่อยครั้ง Last 4 hours" ระหว่างวันที่ 1 - 4 กรกฎาคม 2568</p>
        </header>

        <main>
            <!-- Date Range Filter -->
            <section class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200 mb-8">
                <h2 class="text-xl font-bold text-slate-800 mb-4 text-center">ตัวกรองข้อมูล</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-slate-700 mb-1">จากวันที่:</label>
                        <input type="date" id="startDate" class="w-full p-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-400 focus:border-amber-400 transition">
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-slate-700 mb-1">ถึงวันที่:</label>
                        <input type="date" id="endDate" class="w-full p-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-400 focus:border-amber-400 transition">
                    </div>
                    <div>
                        <button id="applyFilterBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105">
                            กรองข้อมูล
                        </button>
                    </div>
                </div>
            </section>

            <!-- Key Metrics Section -->
            <section id="key-metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center card-enter" title="จำนวนรายงานเหตุการณ์ที่ลูกค้าแจ้งเข้ามาทั้งหมด">
                    <h3 class="text-slate-500 text-sm md:text-base font-semibold">จำนวนเคสที่แจ้ง</h3>
                    <p id="total-incidents" class="text-3xl md:text-4xl font-bold text-slate-900 mt-1"></p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center card-enter" style="animation-delay: 0.3s;" title="จำนวนรหัสร้านค้าที่ไม่ซ้ำกันที่เคยถูกแจ้งปัญหา">
                    <h3 class="text-slate-500 text-sm md:text-base font-semibold">ร้านค้าที่ได้รับผลกระทบ</h3>
                    <p id="total-affected-stores" class="text-3xl md:text-4xl font-bold text-slate-900 mt-1"></p>
                </div>
                <!-- New Metric Cards -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center card-enter" style="animation-delay: 0.4s;" title="จำนวน Ticket ที่ไม่ซ้ำกันทั้งหมดที่ปรากฏในรายงาน">
                    <h3 class="text-slate-500 text-sm md:text-base font-semibold">True Ticket</h3>
                    <p id="total-tickets" class="text-3xl md:text-4xl font-bold text-purple-600 mt-1"></p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center card-enter" style="animation-delay: 0.5s;" title="จำนวน True CID ที่ไม่ซ้ำกันสำหรับปัญหา Main Link">
                    <h3 class="text-slate-500 text-sm md:text-base font-semibold">True CID (Main Link)</h3>
                    <p id="total-true-cids-main-link" class="text-3xl md:text-4xl font-bold text-blue-600 mt-1"></p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center card-enter" style="animation-delay: 0.6s;" title="จำนวน True CID ที่ไม่ซ้ำกันสำหรับปัญหา Backup Link">
                    <h3 class="text-slate-500 text-sm md:text-base font-semibold">True CID (Backup Link)</h3>
                    <p id="total-true-cids-backup-4g" class="text-3xl md:text-4xl font-bold text-amber-600 mt-1"></p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center card-enter cursor-pointer hover:bg-slate-100 transition" style="animation-delay: 0.8s;" id="duplicate-stores-card" title="คลิกเพื่อดูรายชื่อสาขาที่แจ้งปัญหาซ้ำกัน">
                    <h3 class="text-slate-500 text-sm md:text-base font-semibold">จำนวนสาขาที่แจ้งซ้ำกัน</h3>
                    <p id="total-duplicate-stores" class="text-3xl md:text-4xl font-bold text-orange-600 mt-1"></p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center card-enter" style="animation-delay: 0.9s;" id="total-affected-provinces-card" title="คลิกเพื่อดูรายชื่อจังหวัดที่ได้รับผลกระทบ">
                    <h3 class="text-slate-500 text-sm md:text-base font-semibold">จำนวนจังหวัดที่ได้รับผลกระทบ</h3>
                    <p id="total-affected-provinces" class="text-3xl md:text-4xl font-bold text-teal-600 mt-1"></p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center card-enter" style="animation-delay: 1.0s;" id="total-affected-regions-card" title="คลิกเพื่อดูรายชื่อภาคที่ได้รับผลกระทบ">
                    <h3 class="text-slate-500 text-sm md:text-base font-semibold">จำนวนภาคที่ได้รับผลกระทบ</h3>
                    <p id="total-affected-regions" class="text-3xl md:text-4xl font-bold text-indigo-600 mt-1"></p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center col-span-2 md:col-span-4 card-enter" style="animation-delay: 1.1s;">
                    <h3 class="text-slate-500 text-sm md:text-base font-semibold">ปัญหาที่ลูกค้าพบ</h3>
                    <p class="text-xl md:text-2xl font-bold text-slate-900 mt-1">UP/Down บ่อยครั้ง Last 4 hours</p>
                </div>
            </section>

            <!-- Charts Section -->
            <section id="charts-section" class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200 mb-8">
                 <div class="w-full text-center mb-4">
                     <h2 class="text-xl font-bold text-slate-800">ภาพรวมแนวโน้มปัญหา</h2>
                     <p class="text-slate-500 text-sm">ส่วนนี้แสดงข้อมูลสรุปในรูปแบบกราฟ เพื่อให้เห็นแนวโน้มและสัดส่วนของปัญหาที่เกิดขึ้นในแต่ละวันได้ง่ายขึ้น</p>
                 </div>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-bold text-center mb-2 text-slate-700">จำนวนร้านค้าที่ได้รับผลกระทบรายวัน</h3>
                        <div class="chart-container h-72 md:h-80">
                            <canvas id="dailyIncidentsChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-center mb-2 text-slate-700">สัดส่วนร้านค้าที่ได้รับผลกระทบ</h3>
                        <div class="chart-container h-72 md:h-80">
                            <canvas id="problemTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Details Section -->
            <section id="details-section" class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                <div class="w-full text-center mb-4">
                     <h2 class="text-xl font-bold text-slate-800">รายละเอียดเคสปัญหา</h2>
                     <p class="text-slate-500 text-sm">คุณสามารถค้นหาร้านค้าที่ต้องการจากชื่อหรือรหัส และดูรายละเอียดของแต่ละเคสได้ที่นี่</p>
                 </div>

                <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                    <input type="text" id="searchInput" placeholder="🔎 ค้นหารหัสหรือชื่อร้านค้า..." class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-400 focus:border-amber-400 transition col-span-full xl:col-span-2">
                    
                    <input type="text" id="trueCidFilterInput" placeholder="🔎 ค้นหา True CID..." class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-400 focus:border-amber-400 transition col-span-full xl:col-span-1">

                    <select id="problemTypeFilter" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-400 focus:border-amber-400 transition">
                        <option value="">ประเภทปัญหา: ทั้งหมด</option>
                        <option value="Main Link">Main Link</option>
                        <option value="Backup 4G">Backup 4G</option>
                    </select>
                    <select id="ticketStatusFilter" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-400 focus:border-amber-400 transition">
                        <option value="">สถานะ Ticket: ทั้งหมด</option>
                        <option value="hasTicket">มี Ticket</option>
                        <option value="noTicket">ไม่มี Ticket</option>
                    </select>
                    <select id="remarkStatusFilter" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-400 focus:border-amber-400 transition">
                        <option value="">สถานะ Remark: ทั้งหมด</option>
                        <option value="hasRemark">มี Remark</option>
                        <option value="noRemark">ไม่มี Remark</option>
                    </select>
                    <select id="provinceFilter" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-400 focus:border-amber-400 transition">
                        <option value="">จังหวัด: ทั้งหมด</option>
                        <!-- Options populated by JS -->
                    </select>
                    <select id="regionFilter" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-400 focus:border-amber-400 transition">
                        <option value="">ภาค: ทั้งหมด</option>
                        <!-- Options populated by JS -->
                    </select>

                    <button id="downloadCsvBtn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 col-span-full">
                        ⬇️ ดาวน์โหลดข้อมูล (CSV)
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-bold mb-4 text-blue-700">🚨 ปัญหา Main Link</h3>
                        <div id="main-link-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-4 text-amber-700">📡 ปัญหา Backup 4G</h3>
                        <div id="backup-4g-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>
                <div id="no-results" class="text-center py-12 text-slate-500 hidden">
                    <p class="text-lg font-semibold">ไม่พบข้อมูลที่ตรงกับการค้นหา</p>
                    <p>ลองตรวจสอบคำค้นหาของคุณอีกครั้ง</p>
                </div>
            </section>

        </main>
    </div>

    <!-- Duplicate Stores Modal -->
    <div id="duplicateStoresModal" class="modal">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-slate-900 mb-4">รายชื่อสาขาที่แจ้งซ้ำกัน</h2>
            <p class="text-slate-600 mb-4">ด้านล่างนี้คือรายชื่อร้านค้าที่มีการแจ้งปัญหามากกว่าหนึ่งครั้งในรายงาน</p>
            <ul id="duplicate-stores-list" class="space-y-2">
                <!-- Duplicate stores will be listed here -->
            </ul>
        </div>
    </div>

    <!-- Affected Provinces Modal -->
    <div id="affectedProvincesModal" class="modal">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-slate-900 mb-4">รายชื่อจังหวัดที่ได้รับผลกระทบ</h2>
            <p class="text-slate-600 mb-4">ด้านล่างนี้คือรายชื่อจังหวัดที่มีสาขาได้รับผลกระทบในข้อมูลที่กรอง</p>
            <ul id="affected-provinces-list" class="space-y-2">
                <!-- Affected provinces will be listed here -->
            </ul>
        </div>
    </div>

    <!-- Affected Regions Modal -->
    <div id="affectedRegionsModal" class="modal">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-slate-900 mb-4">รายชื่อภาคที่ได้รับผลกระทบ</h2>
            <p class="text-slate-600 mb-4">ด้านล่างนี้คือรายชื่อภาคที่มีสาขาได้รับผลกระทบในข้อมูลที่กรอง</p>
            <ul id="affected-regions-list" class="space-y-2">
                <!-- Affected regions will be listed here -->
            </ul>
        </div>
    </div>

    <script>
        // Mock Store Location Data (Province and Region)
        // This data is for demonstration purposes. You should replace it with your actual, comprehensive location data.
        const storeLocations = {
            '6300': { province: 'สระบุรี', region: 'กลาง' }, // ทับกวาง
            '16081': { province: 'ชลบุรี', region: 'ตะวันออก' }, // PTTOR ทุ่งขวาง-พนัส (ทล.349)
            '16740': { province: 'สระบุรี', region: 'กลาง' }, // บ้านไสม่วง (Mocked, assuming same as Thap Kwang region)
            '11685': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // พีรพงษ์ (BW) - common name, mocked to BKK
            '13098': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // ถนนข้าวปลูก (RC) - common name, mocked to BKK
            '13367': { province: 'ชุมพร', region: 'ใต้' }, // ชุมชนบางลึก
            '6636': { province: 'สุราษฎร์ธานี', region: 'ใต้' }, // ท่าทอง
            '8484': { province: 'กำแพงเพชร', region: 'เหนือ' }, // ปตท.คีรีมาศ (Mocked)
            '9188': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // สี่แยกบ่อนไก่ จุด 2 (Mocked)
            '15903': { province: 'ภูเก็ต', region: 'ใต้' }, // ซอยบางเทา 2
            '16502': { province: 'สระแก้ว', region: 'ตะวันออก' }, // รพ.วัฒนานคร ( สระแก้ว )
            '7085': { province: 'นครปฐม', region: 'กลาง' }, // ชุมชนดอนหวาย (Mocked)
            '1157': { province: 'เชียงใหม่', region: 'เหนือ' }, // ต้นพยอม
            '16759': { province: 'จันทบุรี', region: 'ตะวันออก' }, // PTTOR หนองอ้อ จันทบุรี
            '1692': { province: 'นครปฐม', region: 'กลาง' }, // พุทธมณฑลสาย 7
            '3921': { province: 'เพชรบูรณ์', region: 'เหนือ' }, // ตลาดโพธิ์สุวรรณ
            '10567': { province: 'เชียงราย', region: 'เหนือ' }, // พลมานีย์ จุด 4
            '11351': { province: 'เชียงใหม่', region: 'เหนือ' }, // บ้านสบเปิง (อ.แม่แตง)
            '5057': { province: 'มุกดาหาร', region: 'ตะวันออกเฉียงเหนือ' }, // คำชะอี
            '5282': { province: 'ลำพูน', region: 'เหนือ' }, // บ้านเหมืองง่า
            '15947': { province: 'นครปฐม', region: 'กลาง' }, // ปากทางโรงเรียนการบินกำแพงแสน
            '12003': { province: 'ตาก', region: 'เหนือ' }, // ปตท.แม่ปะ
            '15850': { province: 'ชุมพร', region: 'ใต้' }, // ร้านค้าสวัสดิการค่ายเขตอุดมศักดิ์ (SN)
            '7331': { province: 'พระนครศรีอยุธยา', region: 'กลาง' }, // ปตท.พหลโยธินวังน้อย กม.78
            '13044': { province: 'นครปฐม', region: 'กลาง' }, // ชุมชนนาดี (BW)
            '16634': { province: 'สุโขทัย', region: 'เหนือ' }, // รพ.สุโขทัย
            '1012': { province: 'พระนครศรีอยุธยา', region: 'กลาง' }, // ชุมชนวัดพระญาติ
            '9864': { province: 'พิษณุโลก', region: 'เหนือ' }, // พิษณุโลกพลาซ่า
            '10087': { province: 'พิษณุโลก', region: 'เหนือ' }, // ปตท.เลี่ยงเมืองพิษณุโลก
            '13886': { province: 'นครสวรรค์', region: 'เหนือ' }, // ปตท.หนองบัว (NC)
            '12108': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // พุทธมณฑลสาย 2 ซอย 2 (BW)
            '4312': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // ซอยนวลจิตร จุด 2
            '4728': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // นภาจรัส
            '14222': { province: 'เลย', region: 'ตะวันออกเฉียงเหนือ' }, // PTTOR ด่านซ้าย (NE)
            '11801': { province: 'กำแพงเพชร', region: 'เหนือ' }, // ปตท.หนองปลิงกำแพงเพชร (RC)
            '3225': { province: 'นครปฐม', region: 'กลาง' }, // ธรรมจักร
            '11833': { province: 'สมุทรสาคร', region: 'กลาง' }, // Cargill Factory Market
            '10299': { province: 'สมุทรสาคร', region: 'กลาง' }, // DC MhaChai,
            '10342': { province: 'กำแพงเพชร', region: 'เหนือ' }, // ราชดำเนิน (กำแพงเพชร)
            '1230': { province: 'นครราชสีมา', region: 'ตะวันออกเฉียงเหนือ' }, // สันติสุข
            '3144': { province: 'สระบุรี', region: 'กลาง' }, // ปตท.หินกอง
            '15621': { province: 'ลพบุรี', region: 'กลาง' }, // PTTOR ศูนย์สงครามพิเศษ (RC)(ปตท.100%)
            '5094': { province: 'เชียงราย', region: 'เหนือ' }, // FR.บ้านศรีดอนไชย 1
            '16252': { province: 'ราชบุรี', region: 'กลาง' }, // ตลาดรุ่งโรจน์เจริญทรัพย์
            '992': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // ตลาดสำเหร่
            '15414': { province: 'นครราชสีมา', region: 'ตะวันออกเฉียงเหนือ' }, // ธาราคอนโดเทล 3 (NE)
            '8572': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // รพ.กรุงเทพ(พลาซ่า)
            '13419': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // GAYSORN OFFICE TOWER (BW)
            '338': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // ตลาดพลู
            '5840': { province: 'เชียงใหม่', region: 'เหนือ' }, // ปตท.น้ำแพร่
            '17054': { province: 'ราชบุรี', region: 'กลาง' }, // PTTOR เขาวัง (ราชบุรี)
            '16016': { province: 'สุพรรณบุรี', region: 'กลาง' }, // ศรีประจันต์
            '5000': { province: 'ตาก', region: 'เหนือ' }, // ตากพิทยาคม
            '5583': { province: 'เชียงใหม่', region: 'เหนือ' }, // ตลาดปลาชมภูพงศ์
            '7695': { province: 'กาญจนบุรี', region: 'ตะวันตก' }, // ไปรษณีย์กาญจน์
            '2159': { province: 'สิงห์บุรี', region: 'กลาง' }, // บขส.สิงห์บุรี
            '6927': { province: 'นครปฐม', region: 'กลาง' }, // ซอยประทานพร
            '9307': { province: 'เชียงใหม่', region: 'เหนือ' }, // บ้านหนองโค้ง
            '4172': { province: 'นครปฐม', region: 'กลาง' }, // ปตท.นครชัยศรี
            '6186': { province: 'นนทบุรี', region: 'กลาง' }, // ม.พฤกษาวิลล์ 63-พระราม 5
            '8145': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // อาคารสมเด็จพระเทพรัตน์(ร.พ.รามาฯ)
            '13428': { province: 'ลพบุรี', region: 'กลาง' }, // พัฒนานิคมสาย 4 (เขาสูง) (RC)
            '16045': { province: 'ชลบุรี', region: 'ตะวันออก' }, // PTTOR แยกบ้านบึง
            '17058': { province: 'นครราชสีมา', region: 'ตะวันออกเฉียงเหนือ' }, // ขนงพระใต้
            '8358': { province: 'อุดรธานี', region: 'ตะวันออกเฉียงเหนือ' }, // หลังอุดรทิพย์
            '11174': { province: 'กาญจนบุรี', region: 'ตะวันตก' }, // ท่าไม้
            '3804': { province: 'เชียงใหม่', region: 'เหนือ' }, // ปตทหนองผึ้ง
            '16267': { province: 'อ่างทอง', region: 'กลาง' }, // องครักษ์ อ่างทอง
            '16765': { province: 'นครปฐม', region: 'กลาง' }, // ชุมชนบ้านเจริญสุข(กำแพงแสน)
            '544': { province: 'กาญจนบุรี', region: 'ตะวันตก' }, // ริเวอร์แคว
            '16774': { province: 'สงขลา', region: 'ใต้' }, // PTTOR เขาเขียว (สิงหนคร)
            '16650': { province: 'นครปฐม', region: 'กลาง' }, // เปโตร-ดงเกตุ
            '17034': { province: 'นครปฐม', region: 'กลาง' }, // ศูนย์การแพทย์กาญจนาภิเษก โซน C
            '5072': { province: 'พิษณุโลก', region: 'เหนือ' }, // พระองค์ดำ(พิษณุโลก)
            '4673': { province: 'ขอนแก่น', region: 'ตะวันออกเฉียงเหนือ' }, // อดุลยาราม
            '11107': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // สุขุมวิท 66 (BS)
            '11942': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // SV พระราม 3
            '11470': { province: 'ชลบุรี', region: 'ตะวันออก' }, // คลองตำหรุ 5 (ชลบุรี)
            '3648': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // ซอยบาดาล
            '5566': { province: 'ปทุมธานี', region: 'กลาง' }, // ปทุมทอง 2
            '8629': { province: 'เชียงใหม่', region: 'เหนือ' }, // หน้าโรงพยาบาลมหาราช (เชียงใหม่)
            '11399': { province: 'เชียงใหม่', region: 'เหนือ' }, // แยกสนามบิน2
            '13952': { province: 'เชียงใหม่', region: 'เหนือ' }, // FR.โรงพยาบาลราชเวช (จ.เชียงใหม่)
            '16751': { province: 'นครปฐม', region: 'กลาง' }, // สามพราน ซอย 2
            '9528': { province: 'ลำปาง', region: 'เหนือ' }, // แม่ทะ
            '7016': { province: 'ประจวบคีรีขันธ์', region: 'ตะวันตก' }, // ปตท.บางสะพาน
            '2838': { province: 'นครศรีธรรมราช', region: 'ใต้' }, // ชุมชนท่าศาลา
            '8083': { province: 'เชียงใหม่', region: 'เหนือ' }, // หน้าโรงพยาบาลสารภี
            '11954': { province: 'เชียงใหม่', region: 'เหนือ' }, // ตลาดคลังมาร์เช่
            // New stores from the latest update
            '4674': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // เจริญกรุง 70
            '14000': { province: 'หนองคาย', region: 'ตะวันออกเฉียงเหนือ' }, // ไนท์หนองคาย (NE)
            '7349': { province: 'เชียงใหม่', region: 'เหนือ' }, // ถนนสามล้าน (Mocked)
            '11966': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // RSU Tower (Mocked)
            '14133': { province: 'เพชรบุรี', region: 'ตะวันตก' }, // ชายหาดหนองแจง(ชะอำใต้) (SN)
            '11352': { province: 'สิงห์บุรี', region: 'กลาง' }, // อัมพวัน (สิงห์บุรี)
            '3928': { province: 'นครนายก', region: 'กลาง' }, // ปตท.นครนายก
            '6888': { province: 'นครนายก', region: 'กลาง' }, // ปตท.ฟ้าใส (Mocked)
            '6884': { province: 'ราชบุรี', region: 'กลาง' }, // ปตท.ดอนตะโก (Mocked)
            '7143': { province: 'เชียงราย', region: 'เหนือ' }, // แม่สาย 4 (Mocked)
            '11859': { province: 'นครปฐม', region: 'กลาง' }, // บางน้อยใน (Mocked)
            '6237': { province: 'ระยอง', region: 'ตะวันออก' }, // ห้วยโป่ง ซอย12 (Mocked)
            '2156': { province: 'พระนครศรีอยุธยา', region: 'กลาง' }, // ประตูชัย (อยุธยา)
            '8246': { province: 'นครศรีธรรมราช', region: 'ใต้' }, // ปตท.ทรงธรรม (Mocked)
            '2167': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // Mocked for TK.25061907298
            '3032': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // Mocked for TK.25061903180
            '10622': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // LPN ศรีนครินทร์-หัวหมาก
            '10679': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // รพ.สมิติเวช ศรีนครินทร์
            '13624': { province: 'สมุทรปราการ', region: 'กลาง' }, // หมู่บ้านดีพร้อม(ซอยพุฒสี) (BS)
            '13652': { province: 'เชียงใหม่', region: 'เหนือ' }, // โรงพยาบาลมหาราชนครเชียงใหม่ (S เชียงใหม่)
            '11208': { province: 'เชียงใหม่', region: 'เหนือ' }, // ปตท.เชียงใหม่-ดอยสะเก็ด
            '3853': { province: 'ลำปาง', region: 'เหนือ' }, // อำเภอวังเหนือ
            '16789': { province: 'นครปฐม', region: 'กลาง' }, // ชุมชนดอนยายหอม (นครปฐม)
            '9984': { province: 'นครสวรรค์', region: 'เหนือ' }, // หัวถนน ซ. 11
            '7550': { province: 'ราชบุรี', region: 'กลาง' }, // หนองดินแดง
            '11063': { province: 'ราชบุรี', region: 'กลาง' }, // ดอนตะโก
            '3010': { province: 'นครปฐม', region: 'กลาง' }, // ปตท.ตลาดเมืองใหม่
            '8628': { province: 'ราชบุรี', region: 'กลาง' }, // ปตท.ทุ่งคอก
            '3126': { province: 'ชุมพร', region: 'ใต้' }, // สามแยกแหลมดิน 1
            '3588': { province: 'พระนครศรีอยุธยา', region: 'กลาง' }, // ชุมชนวัดบ้านอ้อย
            '4926': { province: 'ปทุมธานี', region: 'กลาง' }, // ม.เรือนสุข 2 คลอง 9
            '18931': { province: 'สระบุรี', region: 'กลาง' }, // ชุมชนตะกุด(สระบุรี) (RC)
            '13077': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // อ่อนนุช 66 จุด 2 (BS)
            '14998': { province: 'มุกดาหาร', region: 'ตะวันออกเฉียงเหนือ' }, // คำชะอี - Already exists, updating mock data to be consistent
            '11145': { province: 'พิษณุโลก', region: 'เหนือ' }, // วังกรด
            '9770': { province: 'สงขลา', region: 'ใต้' }, // FRตลาดเทพมงคล 2
            '8134': { province: 'นครศรีธรรมราช', region: 'ใต้' }, // นรราชอุทิศ
            '2365': { province: 'ประจวบคีรีขันธ์', region: 'ตะวันตก' }, // สามร้อยยอด
            '6991': { province: 'เชียงใหม่', region: 'เหนือ' }, // นวรัฐ
            '5987': { province: 'สมุทรสาคร', region: 'กลาง' }, // ปตท. LPG พระราม 2 กม. 50
            '3189': { province: 'เชียงใหม่', region: 'เหนือ' }, // อบต.สุเทพ
            '954': { province: 'นครศรีธรรมราช', region: 'ใต้' }, // คฑาธรณ์
            '4173': { province: 'นครปฐม', region: 'กลาง' }, // หมู่บ้านเมืองยิ้ม
            '14496': { province: 'เชียงราย', region: 'เหนือ' }, // แยกน้ำอ่าง
            '16047': { province: 'สมุทรปราการ', region: 'กลาง' }, // Hop Inn บางนา
            '6815': { province: 'กาญจนบุรี', region: 'ตะวันตก' }, // ปตท.ท่าไม้
            '16862': { province: 'อุตรดิตถ์', region: 'เหนือ' }, // PTTOR ลับแล (ฝายหลวง)
            '11326': { province: 'ชัยนาท', region: 'กลาง' }, // ธรรมามูล
            '16531': { province: 'นครศรีธรรมราช', region: 'ใต้' }, // ชุมชนปากนคร
            '11155': { province: 'สมุทรสาคร', region: 'กลาง' }, // เลียบคลองบางน้ำจืด
            '11369': { province: 'ลพบุรี', region: 'กลาง' }, // เมืองนารายณ์
            '6594': { province: 'น่าน', region: 'เหนือ' }, // อ.ปัว
            '2385': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // อารักษ์ 2
            '10749': { province: 'เชียงใหม่', region: 'เหนือ' }, // สวนปาล์ม
            '16887': { province: 'นครสวรรค์', region: 'เหนือ' }, // ริมปิงริเวอร์ไซด์(นครสวรรค์)
            '15264': { province: 'กำแพงเพชร', region: 'เหนือ' }, // ทะเลแก้ว (NC)
            '2077': { province: 'ประจวบคีรีขันธ์', region: 'ตะวันตก' }, // ปตท.ปราณบุรีการค้า
            '4365': { province: 'ชลบุรี', region: 'ตะวันออก' }, // ปตท.สุรศักดิ์ออยล์
            '16253': { province: 'พัทลุง', region: 'ใต้' }, // แยกเขาชัยสน
            '3400': { province: 'นครปฐม', region: 'กลาง' }, // ปตท.เกษมราษฎร์
            '16517': { province: 'นครศรีธรรมราช', region: 'ใต้' }, // นาโบสถ์
            '3030': { province: 'พิษณุโลก', region: 'เหนือ' }, // ม.นเรศวร (ตลาดเมืองทอง )
            '8148': { province: 'ลพบุรี', region: 'กลาง' }, // ปตท.พัฒนานิคม
            '614': { province: 'ราชบุรี', region: 'กลาง' }, // โพธาราม
            '6213': { province: 'พิษณุโลก', region: 'เหนือ' }, // ถนนบรมไตรโลกนารถ
            '13959': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // Belle Park (BW)
            '4018': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // ประดู่ 7
            '16593': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // ปรีดีพนมยงค์ 41
            '5552': { province: 'สมุทรปราการ', region: 'กลาง' }, // บ้านคลองสวน
            '6706': { province: 'บึงกาฬ', region: 'ตะวันออกเฉียงเหนือ' }, // เซกา
            '4525': { province: 'สระบุรี', region: 'กลาง' }, // ปตท.หินกอง 2
            '8239': { province: 'ราชบุรี', region: 'กลาง' }, // ปตท.ดอนทราย (ปากท่อ)
            '11708': { province: 'เชียงใหม่', region: 'เหนือ' }, // บ้านทุ่งหมื่นน้อย (อ.สันทราย)
            '17124': { province: 'นครศรีธรรมราช', region: 'ใต้' }, // พรหมมาสตร์
            '851': { province: 'สมุทรสาคร', region: 'กลาง' }, // คลองครุ
            '9716': { province: 'พระนครศรีอยุธยา', region: 'กลาง' }, // บางซ้าย
            '14209': { province: 'น่าน', region: 'เหนือ' }, // PTTOR สุขุมปัว (NC)
            '5147': { province: 'เชียงใหม่', region: 'เหนือ' }, // ตลาดแม่กวง
            '16695': { province: 'พระนครศรีอยุธยา', region: 'กลาง' }, // พลัส คอนโด อยุธยาพาร์ค
            '10644': { province: 'ลำปาง', region: 'เหนือ' }, // ปตท.แยกเวียงทอง
            '10858': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // อิสรภาพ 31
            '9992': { province: 'ชัยนาท', region: 'กลาง' }, // เทศบาล 4 ชัยนาท
            '14085': { province: 'กรุงเทพมหานคร', region: 'กลาง' }, // Silom Terrace
        };

        // Thai Regions Mapping (for mock data)
        const thaiRegions = {
            'เหนือ': ['เชียงราย', 'เชียงใหม่', 'น่าน', 'พะเยา', 'แพร่', 'แม่ฮ่องสอน', 'ลำปาง', 'ลำพูน', 'อุตรดิตถ์', 'สุโขทัย', 'พิษณุโลก', 'พิจิตร', 'กำแพงเพชร', 'เพชรบูรณ์', 'นครสวรรค์', 'อุทัยธานี', 'ตาก'],
            'ตะวันออกเฉียงเหนือ': ['กาฬสินธุ์', 'ขอนแก่น', 'ชัยภูมิ', 'นครพนม', 'นครราชสีมา', 'บึงกาฬ', 'บุรีรัมย์', 'มหาสารคาม', 'มุกดาหาร', 'ยโสธร', 'ร้อยเอ็ด', 'เลย', 'ศรีสะเกษ', 'สกลนคร', 'สุรินทร์', 'หนองคาย', 'หนองบัวลำภู', 'อุดรธานี', 'อุบลราชธานี', 'อำนาจเจริญ'],
            'กลาง': ['กรุงเทพมหานคร', 'กาญจนบุรี', 'ชัยนาท', 'นครนายก', 'นครปฐม', 'นนทบุรี', 'ปทุมธานี', 'พระนครศรีอยุธยา', 'เพชรบุรี', 'ราชบุรี', 'ลพบุรี', 'สมุทรปราการ', 'สมุทรสงคราม', 'สมุทรสาคร', 'สระบุรี', 'สิงห์บุรี', 'สุพรรณบุรี', 'อ่างทอง'],
            'ตะวันออก': ['จันทบุรี', 'ฉะเชิงเทรา', 'ชลบุรี', 'ตราด', 'ปราจีนบุรี', 'ระยอง', 'สระแก้ว'],
            'ตะวันตก': ['กาญจนบุรี', 'ตาก', 'ประจวบคีรีขันธ์', 'เพชรบุรี', 'ราชบุรี'],
            'ใต้': ['กระบี่', 'ชุมพร', 'ตรัง', 'นครศรีธรรมราช', 'นราธิวาส', 'ปัตตานี', 'พังงา', 'พัทลุง', 'ภูเก็ต', 'ยะลา', 'ระนอง', 'สงขลา', 'สตูล', 'สุราษฎร์ธานี']
        };

        // Function to get region from province
        function getRegion(province) {
            for (const region in thaiRegions) {
                if (thaiRegions[region].includes(province)) {
                    return region;
                }
            }
            return 'ไม่ทราบภาค'; // Default if not found
        }

        // Raw CSV data from the previous update and new data from [LINE]Solving Router Hang 2.txt and 3.txt
        const rawCsvData = `Date,Time,Ticket,True CID,Problem Type,Store ID,Store Name,Remark
2025.05.02,16:09,,FTTX,Main Link,5642,ศุภาลัยพาร์ควิลล์ วงแหวน-ราชพฤกษ์,Fiber 1C Core ขาดเนื่องจากCore crack
2025.05.02,16:09,,NE,Main Link,14840,พระทองคำ (NE),Fiber optic 24 core high loss
2025.05.06,16:09,,FTTX,Main Link,14098,ตลาดเขาไม้แก้ว,Fiber ขาด
2025.05.06,16:09,,FTTX,Main Link,2273,ปตท.เขาไม้แก้ว,Fiber ขาด
2025.05.06,16:09,,FTTX,Main Link,737,ลาดพร้าว 39,ไฟฟ้าดับแล้ว Router เสีย
2025.06.19,18:05,TK.25061907298,,Main Link,2167,,
2025.06.19,18:05,TK.25061903180,,Main Link,3032,,
2025.06.24,09:21,,FTTX,Main Link,10460,บ้านป่าเป้า (จ.ลำพูน),
2025.06.24,09:21,,FTTX,Main Link,3032,Booth ซอยลูกหลวง,
2025.06.24,09:21,,FTTX,Main Link,10622,LPN ศรีนครินทร์-หัวหมาก,
2025.06.24,09:21,,FTTX,Main Link,10679,รพ.สมิติเวช ศรีนครินทร์,
2025.06.24,09:21,,FTTX,Main Link,13624,หมู่บ้านดีพร้อม(ซอยพุฒสี) (BS),
2025.06.24,09:21,,4G,Backup 4G,13652,โรงพยาบาลมหาราชนครเชียงใหม่ (S เชียงใหม่),
2025.06.24,09:21,,4G,Backup 4G,11208,ปตท.เชียงใหม่-ดอยสะเก็ด,
2025.06.24,09:21,,4G,Backup 4G,3853,อำเภอวังเหนือ,
2025.06.24,09:21,,4G,Backup 4G,16789,ชุมชนดอนยายหอม (นครปฐม),
2025.06.24,09:21,,4G,Backup 4G,9984,หัวถนน ซ. 11,
2025.06.24,09:21,,4G,Backup 4G,7550,หนองดินแดง,
2025.06.24,09:21,,4G,Backup 4G,4645,ห้าแยกสันติธรรม 2,
2025.06.24,09:21,,4G,Backup 4G,11063,ดอนตะโก,
2025.06.24,09:21,,4G,Backup 4G,15994,ซอยโรงเหล็ก จุด 2,
2025.06.24,09:21,,4G,Backup 4G,9742,ชุมตาบง,
2025.06.24,14:01,,FTTX,Main Link,5193,ท่าเรือแหลมเทียน,
2025.06.24,14:01,,FTTX,Main Link,8537,ชุมชนวัดคูยาง,
2025.06.24,14:01,,FTTX,Main Link,13078,มศว.ประสานมิตร(ประตู 3) (BS),
2025.06.24,14:01,,FTTX,Main Link,3032,Booth ซอยลูกหลวง,
2025.06.24,14:01,,FTTX,Main Link,13150,สุขุมวิท-บ้านอำเภอ (RE),
2025.06.24,14:01,,4G,Backup 4G,4645,ห้าแยกสันติธรรม 2,
2025.06.24,14:01,,4G,Backup 4G,6837,แยกห้วยไผ่,
2025.06.24,14:01,,4G,Backup 4G,16922,ลีเล็ด (ท่าฉาง),
2025.06.24,14:01,,4G,Backup 4G,11208,ปตท.เชียงใหม่-ดอยสะเก็ด,
2025.06.24,14:01,,4G,Backup 4G,3010,ปตท.ตลาดเมืองใหม่,
2025.06.24,14:01,,4G,Backup 4G,8628,ปตท.ทุ่งคอก,
2025.06.24,14:01,,4G,Backup 4G,6539,ปตท.จิงโจ้,
2025.06.24,14:01,,4G,Backup 4G,3126,สามแยกแหลมดิน 1,
2025.06.24,14:01,,4G,Backup 4G,3588,ชุมชนวัดบ้านอ้อย,
2025.06.24,14:01,,4G,Backup 4G,9628,อำเภอบางแพ,
2025.06.25,09:15,,FTTX,Main Link,10460,บ้านป่าเป้า (จ.ลำพูน),
2025.06.25,09:15,,FTTX,Main Link,18570,โป่งตาลอง(ปากช่อง),
2025.06.25,09:15,,FTTX,Main Link,11534,กลางซอยศรีบุญเรือง,
2025.06.25,09:15,,FTTX,Main Link,14985,PTTOR ทุ่งเบญจา (RE),
2025.06.25,09:15,,FTTX,Main Link,1292,ทรงสวัสดิ์,
2025.06.25,09:16,,4G,Backup 4G,4645,ห้าแยกสันติธรรม 2,
2025.06.25,09:16,,4G,Backup 4G,9742,ชุมตาบง,
2025.06.25,09:16,,4G,Backup 4G,9628,อำเภอบางแพ,
2025.06.25,09:16,,4G,Backup 4G,2876,ถนนแม่น้ำแคว,
2025.06.25,09:16,,4G,Backup 4G,6402,ลำนารายณ์ 3,
2025.06.25,09:16,,4G,Backup 4G,10652,ปตท.พหลโยธินพระพุทธบาท,
2025.06.25,09:16,,4G,Backup 4G,15994,ซอยโรงเหล็ก จุด 2,
2025.06.25,09:16,,4G,Backup 4G,7566,โรงพยาบาลเอกชัย,
2025.06.25,09:16,,4G,Backup 4G,300,มหาชัย 2,
2025.06.25,09:16,,4G,Backup 4G,10587,ตลาดป่ายาง,
2025.06.25,13:31,,FTTX,Main Link,10460,บ้านป่าเป้า (จ.ลำพูน),
2025.06.25,13:31,,FTTX,Main Link,13142,บางแวก-สาย2(ซอยกล้วยไม้)BW,
2025.06.25,13:31,,FTTX,Main Link,2426,นานาเหนือ (สุขุมวิท 3),
2025.06.25,13:31,,FTTX,Main Link,15405,ชุมชนเฟื่องฟ้า(ทับกวาง) (NC),
2025.06.25,13:31,,FTTX,Main Link,16586,ดอนมดแดง,
2025.06.25,13:32,,4G,Backup 4G,4645,ห้าแยกสันติธรรม 2,
2025.06.25,13:32,,4G,Backup 4G,15994,ซอยโรงเหล็ก จุด 2,
2025.06.25,13:32,,4G,Backup 4G,16767,ตลาดสวนแตง,
2025.06.25,13:32,,4G,Backup 4G,6539,ปตท.จิงโจ้,
2025.06.25,13:32,,4G,Backup 4G,2876,ถนนแม่น้ำแคว,
2025.06.25,13:32,,4G,Backup 4G,9628,อำเภอบางแพ,
2025.06.25,13:32,,4G,Backup 4G,10652,ปตท.พหลโยธินพระพุทธบาท,
2025.06.25,13:32,,4G,Backup 4G,9271,ลาดปลาเค้า (นครปฐม),
2025.06.25,13:32,,4G,Backup 4G,11045,พรุฉิมพลี ซอย 1,
2025.06.25,13:32,,4G,Backup 4G,10975,ชุมชนธรรมศาลา,
2025.06.26,09:11,,FTTX,Main Link,1637,ริเวอร์ปาร์ค,
2025.06.26,09:11,,FTTX,Main Link,10460,บ้านป่าเป้า (จ.ลำพูน),
2025.06.26,09:11,,FTTX,Main Link,11590,ท่ามะนาว (RN),
2025.06.26,09:11,,FTTX,Main Link,10630,ซอย อบต.เทพารักษ์,
2025.06.26,09:11,,FTTX,Main Link,9075,ตลาดหนองปรือ,
2025.06.26,09:11,,4G,Backup 4G,8056,ดอนขนาก,
2025.06.26,09:11,,4G,Backup 4G,9628,อำเภอบางแพ,
2025.06.26,09:11,,4G,Backup 4G,9742,ชุมตาบง,
2025.06.26,09:11,,4G,Backup 4G,2876,ถนนแม่น้ำแคว,
2025.06.26,09:11,,4G,Backup 4G,4477,ชุมชนวัดคานหาม 4,
2025.06.26,09:11,,4G,Backup 4G,16922,ลีเล็ด (ท่าฉาง),
2025.06.26,09:11,,4G,Backup 4G,10587,ตลาดป่ายาง,
2025.06.26,09:11,,4G,Backup 4G,11045,พรุฉิมพลี ซอย 1,
2025.06.26,09:11,,4G,Backup 4G,5502,บางปลาหมอ,
2025.06.26,09:11,,4G,Backup 4G,3588,ชุมชนวัดบ้านอ้อย,
2025.06.26,13:32,,FTTX,Main Link,4926,ม.เรือนสุข 2 คลอง 9,
2025.06.26,13:32,,FTTX,Main Link,10460,ชุมชนหนองเป็ดน้ำ,
2025.06.26,13:32,,FTTX,Main Link,18931,ชุมชนตะกุด(สระบุรี) (RC),
2025.06.26,13:32,,FTTX,Main Link,13077,อ่อนนุช 66 จุด 2 (BS),
2025.06.26,13:32,,FTTX,Main Link,14998,คำชะอี,
2025.06.26,13:33,,4G,Backup 4G,11145,วังกรด,
2025.06.26,13:33,,4G,Backup 4G,9770,FRตลาดเทพมงคล 2,
2025.06.26,13:33,,4G,Backup 4G,13367,ชุมชนบางลึก,
2025.06.26,13:33,,4G,Backup 4G,8134,นรราชอุทิศ,
2025.06.26,13:33,,4G,Backup 4G,2365,สามร้อยยอด,
2025.06.26,13:33,,4G,Backup 4G,6991,นวรัฐ,
2025.06.26,13:33,,4G,Backup 4G,5987,ปตท. LPG พระราม 2 กม. 50,
2025.06.26,13:33,,4G,Backup 4G,3189,อบต.สุเทพ,
2025.06.26,13:33,,4G,Backup 4G,954,คฑาธรณ์,
2025.06.26,13:33,,4G,Backup 4G,4173,หมู่บ้านเมืองยิ้ม,
2025.06.27,09:17,,FTTX,Main Link,10460,บ้านป่าเป้า (จ.ลำพูน),
2025.06.27,09:17,,FTTX,Main Link,1637,ริเวอร์ปาร์ค,
2025.06.27,09:17,,FTTX,Main Link,13730,ซอยธรรมศิริ (บางนา กม.25) (BS),
2025.06.27,09:17,,FTTX,Main Link,14496,แยกน้ำอ่าง,
2025.06.27,09:17,,FTTX,Main Link,16047,Hop Inn บางนา,
2025.06.27,09:18,,4G,Backup 4G,6815,ปตท.ท่าไม้,
2025.06.27,09:18,,4G,Backup 4G,16002,PS พฤกษาวิลล์ 99 เพชรเกษม 93(อ้อมน้อย),
2025.06.27,09:18,,4G,Backup 4G,16862,PTTOR ลับแล (ฝายหลวง),
2025.06.27,09:18,,4G,Backup 4G,12003,ปตท.แม่ปะ,
2025.06.27,09:18,,4G,Backup 4G,11326,ธรรมามูล,
2025.06.27,09:18,,4G,Backup 4G,16531,ชุมชนปากนคร,
2025.06.27,09:18,,4G,Backup 4G,11155,เลียบคลองบางน้ำจืด,
2025.06.27,09:18,,4G,Backup 4G,17034,ศูนย์การแพทย์กาญจนาภิเษก โซน C,
2025.06.27,09:18,,4G,Backup 4G,11369,เมืองนารายณ์,
2025.06.27,09:18,,4G,Backup 4G,6594,อ.ปัว,
2025.06.27,14:25,,FTTX,Main Link,16047,Hop Inn บางนา,
2025.06.27,14:25,,FTTX,Main Link,2385,อารักษ์ 2,
2025.06.27,14:25,,FTTX,Main Link,10749,สวนปาล์ม,
2025.06.27,14:25,,FTTX,Main Link,16887,ริมปิงริเวอร์ไซด์(นครสวรรค์),
2025.06.27,14:25,,FTTX,Main Link,15264,ทะเลแก้ว (NC),
2025.06.27,14:26,,4G,Backup 4G,2077,ปตท.ปราณบุรีการค้า,
2025.06.27,14:26,,4G,Backup 4G,4365,ปตท.สุรศักดิ์ออยล์,
2025.06.27,14:26,,4G,Backup 4G,16253,แยกเขาชัยสน,
2025.06.27,14:26,,4G,Backup 4G,15994,ซอยโรงเหล็ก จุด 2,
2025.06.27,14:26,,4G,Backup 4G,3400,ปตท.เกษมราษฎร์,
2025.06.27,14:26,,4G,Backup 4G,16517,นาโบสถ์,
2025.06.27,14:26,,4G,Backup 4G,3030,ม.นเรศวร (ตลาดเมืองทอง ),
2025.06.27,14:26,,4G,Backup 4G,8148,ปตท.พัฒนานิคม,
2025.06.27,14:26,,4G,Backup 4G,614,โพธาราม,
2025.06.27,14:26,,4G,Backup 4G,6213,ถนนบรมไตรโลกนารถ,
2025.06.30,09:11,,FTTX,Main Link,13959,Belle Park (BW),
2025.06.30,09:11,,FTTX,Main Link,4018,ประดู่ 7,
2025.06.30,09:11,,FTTX,Main Link,16593,ปรีดีพนมยงค์ 41,
2025.06.30,09:11,,FTTX,Main Link,5552,บ้านคลองสวน,
2025.06.30,09:11,,FTTX,Main Link,6706,เซกา,
2025.06.30,09:12,,4G,Backup 4G,4525,ปตท.หินกอง 2,
2025.06.30,09:12,,4G,Backup 4G,16002,PS พฤกษาวิลล์ 99 เพชรเกษม 93(อ้อมน้อย),
2025.06.30,09:12,,4G,Backup 4G,8239,ปตท.ดอนทราย (ปากท่อ),
2025.06.30,09:12,,4G,Backup 4G,11708,บ้านทุ่งหมื่นน้อย (อ.สันทราย),
2025.06.30,09:12,,4G,Backup 4G,17124,พรหมมาสตร์,
2025.06.30,09:12,,4G,Backup 4G,851,คลองครุ,
2025.06.30,09:12,,4G,Backup 4G,9716,บางซ้าย,
2025.06.30,09:12,,4G,Backup 4G,14209,PTTOR สุขุมปัว (NC),
2025.06.30,09:12,,4G,Backup 4G,5147,ตลาดแม่กวง,
2025.06.30,09:12,,4G,Backup 4G,16695,พลัส คอนโด อยุธยาพาร์ค,
2025.06.30,14:01,,FTTX,Main Link,10644,ปตท.แยกเวียงทอง,
2025.06.30,14:01,,FTTX,Main Link,10858,อิสรภาพ 31,
2025.06.30,14:01,,FTTX,Main Link,9992,เทศบาล 4 ชัยนาท,
2025.06.30,14:01,,FTTX,Main Link,11145,วังกรด,
2025.06.30,14:01,,FTTX,Main Link,14085,Silom Terrace,
2025.06.30,14:02,,4G,Backup 4G,16922,ลีเล็ด (ท่าฉาง),
2025.06.30,14:02,,4G,Backup 4G,13135,สุขเจริญ,
2025.06.30,14:02,,4G,Backup 4G,4835,จอมบึง 2,
2025.06.30,14:02,,4G,Backup 4G,16668,PTTOR ชัยบุรี,
2025.06.30,14:02,,4G,Backup 4G,6815,ปตท.ท่าไม้,
2025.06.30,14:02,,4G,Backup 4G,8239,ปตท.ดอนทราย (ปากท่อ),
2025.06.30,14:02,,4G,Backup 4G,17054,PTTOR เขาวัง (ราชบุรี),
06/30/2025,14:02,,4G,Backup 4G,773,ตลาดอัศวิน,
06/30/2025,14:02,,4G,Backup 4G,5664,แยกนวมินทร์นครสวรรค์,
06/30/2025,14:02,,4G,Backup 4G,17012,วัดยกกระบัตร,
2025.07.01,09:28,,4G,Main Link,16757,ดอนบม,
2025.07.01,09:28,,4G,Main Link,1111,ตลาดปากคลอง,
2025.07.01,09:28,,4G,Main Link,6186,ม.พฤกษาวิลล์ 63-พระราม 5,
2025.07.01,09:28,,4G,Main Link,10691,บ้านแม่สารป่าแดด (จ.ลำพูน),
2025.07.01,09:28,,4G,Main Link,13474,เด่นนครเรสซิเดนท์ เพชรเกษม 63,
2025.07.01,09:29,,4G,Backup 4G,1938,อัญสัมชัญลำปาง,
2025.07.01,09:29,,4G,Backup 4G,9637,FR. บ้านป่าข่อยใต้,
2025.07.01,09:29,,4G,Backup 4G,5351,คลองขลุง,
2025.07.01,09:29,,4G,Backup 4G,6214,พญาชาละวัน,
2025.07.01,09:29,,4G,Backup 4G,6815,ปตท.ท่าไม้,
2025.07.01,09:29,,4G,Backup 4G,5670,สระกระเทียม,
2025.07.01,09:29,,4G,Backup 4G,16162,บ้านช่างเคิ่งบน(อ.แม่แจ่ม),
2025.07.01,09:29,,4G,Backup 4G,9209,หน้าหมู่บ้านขวัญเวียง,
2025.07.01,09:29,,4G,Backup 4G,16464,หน้ารพ.เขลางค์นคร-ราม,
2025.07.01,09:29,,4G,Backup 4G,2749,ชุมชนวัดโคกมะยม,
2025.07.01,15:32,,4G,Main Link,6300,ทับกวาง,
2025.07.01,15:32,,4G,Main Link,16081,PTTOR ทุ่งขวาง-พนัส (ทล.349),
2025.07.01,15:32,,4G,Main Link,16740,บ้านไสม่วง,
2025.07.01,15:32,,BW,Main Link,11685,พีรพงษ์ (BW),
2025.07.01,15:32,,RC,Main Link,13098,ถนนข้าวปลูก (RC),
2025.07.01,15:32,,4G,Backup 4G,13367,ชุมชนบางลึก,
2025.07.01,15:32,,4G,Backup 4G,6636,ท่าทอง,
2025.07.01,15:32,,4G,Backup 4G,8484,ปตท.คีรีมาศ,
2025.07.01,15:32,,4G,Backup 4G,9188,สี่แยกบ่อนไก่ จุด 2,
2025.07.01,15:32,,4G,Backup 4G,15903,ซอยบางเทา 2,
2025.07.01,15:32,,4G,Backup 4G,16502,รพ.วัฒนานคร ( สระแก้ว ),
2025.07.01,15:32,,4G,Backup 4G,7085,ชุมชนดอนหวาย,
2025.07.01,15:32,,4G,Backup 4G,1157,ต้นพยอม,
2025.07.01,15:32,,4G,Backup 4G,16759,PTTOR หนองอ้อ จันทบุรี,
2025.07.01,15:32,,4G,Backup 4G,1692,พุทธมณฑลสาย 7,
2025.07.02,09:38,,4G,Main Link,3921,ตลาดโพธิ์สุวรรณ,
2025.07.02,09:38,,4G,Main Link,10567,พลมานีย์ จุด 4,
2025.07.02,09:38,,4G,Main Link,11351,บ้านสบเปิง (อ.แม่แตง),
2025.07.02,09:38,,4G,Main Link,5057,คำชะอี,
2025.07.02,09:38,,4G,Main Link,5282,บ้านเหมืองง่า,
2025.07.02,09:39,,4G,Backup 4G,15947,ปากทางโรงเรียนการบินกำแพงแสน,
2025.07.02,09:39,,4G,Backup 4G,12003,ปตท.แม่ปะ,
2025.07.02,09:39,,4G,Backup 4G,15850,ร้านค้าสวัสดิการค่ายเขตอุดมศักดิ์ (SN),
2025.07.02,09:39,,4G,Backup 4G,7331,ปตท.พหลโยธินวังน้อย กม.78,
2025.07.02,09:39,,4G,Backup 4G,1692,พุทธมณฑลสาย 7,
2025.07.02,09:39,,BW,Backup 4G,13044,ชุมชนนาดี (BW),
2025.07.02,09:39,,4G,Backup 4G,16634,รพ.สุโขทัย,
2025.07.02,09:39,,4G,Backup 4G,1012,ชุมชนวัดพระญาติ,
2025.07.02,09:39,,4G,Backup 4G,9864,พิษณุโลกพลาซ่า,
2025.07.02,09:39,,4G,Backup 4G,10087,ปตท.เลี่ยงเมืองพิษณุโลก,
2025.07.02,13:40,,NC,Main Link,13886,ปตท.หนองบัว (NC),
2025.07.02,13:40,,BW,Main Link,12108,พุทธมณฑลสาย 2 ซอย 2 (BW),
2025.07.02,13:40,,BW,Main Link,4312,ซอยนวลจิตร จุด 2,
2025.07.02,13:40,,Main Link,4728,นภาจรัส,
2025.07.02,13:40,,NE,Main Link,14222,PTTOR ด่านซ้าย (NE),
2025.07.02,13:41,,RC,Backup 4G,11801,ปตท.หนองปลิงกำแพงเพชร (RC),
2025.07.02,13:41,,Backup 4G,3225,ธรรมจักร,
2025.07.02,13:41,,Backup 4G,11833,Cargill Factory Market,
2025.07.02,13:41,,Backup 4G,10299,DC MhaChai,
2025.07.02,13:41,,Backup 4G,10342,ราชดำเนิน (กำแพงเพชร),
2025.07.02,13:41,,Backup 4G,1230,สันติสุข,
2025.07.02,13:41,,Backup 4G,3144,ปตท.หินกอง,
2025.07.02,13:41,,RC,Backup 4G,15621,PTTOR ศูนย์สงครามพิเศษ (RC)(ปตท.100%),
2025.07.02,13:41,,Backup 4G,5094,FR.บ้านศรีดอนไชย 1,
2025.07.02,13:41,,Backup 4G,16252,ตลาดรุ่งโรจน์เจริญทรัพย์,
2025.07.03,09:20,,BW,Main Link,992,ตลาดสำเหร่,
2025.07.03,09:20,,NE,Main Link,15414,ธาราคอนโดเทล 3 (NE),
2025.07.03,09:20,,BW,Main Link,8572,รพ.กรุงเทพ(พลาซ่า),
2025.07.03,09:20,,BW,Main Link,13419,GAYSORN OFFICE TOWER (BW),
2025.07.03,09:20,,BW,Main Link,338,ตลาดพลู,
2025.07.03,09:20,,4G,Backup 4G,5840,ปตท.น้ำแพร่,
2025.07.03,09:20,,4G,Backup 4G,17054,PTTOR เขาวัง (ราชบุรี),
2025.07.03,09:20,,4G,Backup 4G,16016,ศรีประจันต์,
2025.07.03,09:20,,4G,Backup 4G,5000,ตากพิทยาคม,
2025.07.03,09:20,,4G,Backup 4G,5583,ตลาดปลาชมภูพงศ์,
2025.07.03,09:20,,4G,Backup 4G,7695,ไปรษณีย์กาญจน์,
2025.07.03,09:20,,4G,Backup 4G,2159,บขส.สิงห์บุรี,
2025.07.03,09:20,,4G,Backup 4G,6927,ซอยประทานพร,
2025.07.03,09:20,,4G,Backup 4G,9307,บ้านหนองโค้ง,
2025.07.03,09:20,,4G,Backup 4G,4172,ปตท.นครชัยศรี,
2025.07.03,13:38,,Main Link,6186,ม.พฤกษาวิลล์ 63-พระราม 5,
2025.07.03,13:38,,Main Link,8145,อาคารสมเด็จพระเทพรัตน์(ร.พ.รามาฯ),
2025.07.03,13:38,,RC,Main Link,13428,พัฒนานิคมสาย 4 (เขาสูง) (RC),
2025.07.03,13:38,,Main Link,16045,PTTOR แยกบ้านบึง,
2025.07.03,13:38,,Main Link,17058,ขนงพระใต้,
2025.07.03,13:38,,Backup 4G,8358,หลังอุดรทิพย์,
2025.07.03,13:38,,Backup 4G,11174,ท่าไม้,
2025.07.03,13:38,,Backup 4G,3804,ปตทหนองผึ้ง,
2025.07.03,13:38,,Backup 4G,16267,องครักษ์ อ่างทอง,
2025.07.03,13:38,,Backup 4G,16765,ชุมชนบ้านเจริญสุข(กำแพงแสน),
2025.07.03,13:38,,Backup 4G,544,ริเวอร์แคว,
2025.07.03,13:38,,Backup 4G,16774,PTTOR เขาเขียว (สิงหนคร),
2025.07.03,13:38,,Backup 4G,16650,เปโตร-ดงเกตุ,
2025.07.03,13:38,,Backup 4G,17034,ศูนย์การแพทย์กาญจนาภิเษก โซน C,
2025.07.03,13:38,,Backup 4G,5072,พระองค์ดำ(พิษณุโลก),
2025.07.04,09:32,,Main Link,4673,อดุลยาราม,
2025.07.04,09:32,,BS,Main Link,11107,สุขุมวิท 66 (BS),
2025.07.04,09:32,,Main Link,11942,SV พระราม 3,
2025.07.04,09:32,,Main Link,11470,คลองตำหรุ 5 (ชลบุรี),
2025.07.04,09:32,,Main Link,3648,ซอยบาดาล,
2025.07.04,09:32,,Backup 4G,5566,ปทุมทอง 2,
2025.07.04,09:32,,Backup 4G,8629,หน้าโรงพยาบาลมหาราช (เชียงใหม่),
2025.07.04,09:32,,Backup 4G,11399,แยกสนามบิน2,
2025.07.04,09:32,,Backup 4G,13952,FR.โรงพยาบาลราชเวช (จ.เชียงใหม่),
2025.07.04,09:32,,Backup 4G,16751,สามพราน ซอย 2,
2025.07.04,09:32,,Backup 4G,9528,แม่ทะ,
2025.07.04,09:32,,Backup 4G,7016,ปตท.บางสะพาน,
2025.07.04,09:32,,Backup 4G,2838,ชุมชนท่าศาลา,
2025.07.04,09:32,,Backup 4G,8083,หน้าโรงพยาบาลสารภี,
2025.07.04,09:32,,Backup 4G,11954,ตลาดคลังมาร์เช่,
2025.07.04,13:34,,FTTX,Main Link,4674,เจริญกรุง 70,
2025.07.04,13:34,,NE,Main Link,14000,ไนท์หนองคาย (NE),
2025.07.04,13:34,,FTTX,Main Link,7349,ถนนสามล้าน,
2025.07.04,13:34,,FTTX,Main Link,11966,RSU Tower,
2025.07.04,13:34,,SN,Main Link,14133,ชายหาดหนองแจง(ชะอำใต้),
2025.07.04,13:34,,4G,Backup 4G,8629,หน้าโรงพยาบาลมหาราช (เชียงใหม่),
2025.07.04,13:34,,4G,Backup 4G,11352,อัมพวัน (สิงห์บุรี),
2025.07.04,13:34,,4G,Backup 4G,3928,ปตท.นครนายก,
2025.07.04,13:34,,4G,Backup 4G,6888,ปตท.ฟ้าใส,
2025.07.04,13:34,,4G,Backup 4G,6884,ปตท.ดอนตะโก,
2025.07.04,13:34,,4G,Backup 4G,7143,แม่สาย 4,
2025.07.04,13:34,,4G,Backup 4G,11859,บางน้อยใน,
2025.07.04,13:34,,4G,Backup 4G,6237,ห้วยโป่ง ซอย12,
2025.07.04,13:34,,4G,Backup 4G,2156,ประตูชัย (อยุธยา),
2025.07.04,13:34,,4G,Backup 4G,8246,ปตท.ทรงธรรม,
`;

        // Function to parse CSV string into an array of objects
        function parseCsv(csvString) {
            const lines = csvString.trim().split('\n');
            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].trim() : '';
                });
                data.push(row);
            }
            return data;
        }

        // Process the raw CSV data
        const parsedCsvData = parseCsv(rawCsvData);
        let currentlyDisplayedData = []; // This will hold individual rows after all filters are applied

        // Calculate duplicate store IDs once from the full dataset (for the "(แจ้งซ้ำ)" tag)
        const storeIdCountsAllData = new Map();
        parsedCsvData.forEach(row => {
            storeIdCountsAllData.set(row['Store ID'], (storeIdCountsAllData.get(row['Store ID']) || 0) + 1);
        });
        const duplicateStoreIdsAllData = new Set();
        for (const [storeId, count] of storeIdCountsAllData.entries()) {
            if (count > 1) {
                duplicateStoreIdsAllData.add(storeId);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Set default date range to cover all data
            const dates = parsedCsvData.map(row => new Date(row.Date.split('/').reverse().join('-')));
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));

            document.getElementById('startDate').valueAsDate = minDate;
            document.getElementById('endDate').valueAsDate = maxDate;

            // Populate Province and Region filters
            populateLocationFilters();

            initializeDashboard();

            document.getElementById('applyFilterBtn').addEventListener('click', updateDashboard);
            document.getElementById('searchInput').addEventListener('input', updateDashboard);
            document.getElementById('trueCidFilterInput').addEventListener('input', updateDashboard); // New event listener for True CID filter
            document.getElementById('problemTypeFilter').addEventListener('change', updateDashboard);
            document.getElementById('ticketStatusFilter').addEventListener('change', updateDashboard);
            document.getElementById('remarkStatusFilter').addEventListener('change', updateDashboard);
            document.getElementById('provinceFilter').addEventListener('change', updateDashboard);
            document.getElementById('regionFilter').addEventListener('change', updateDashboard);
            document.getElementById('downloadCsvBtn').addEventListener('click', downloadCsv);

            // Modal event listeners
            const duplicateStoresCard = document.getElementById('duplicate-stores-card');
            if (duplicateStoresCard) {
                duplicateStoresCard.addEventListener('click', showDuplicateStoresModal);
            }
            document.querySelector('#duplicateStoresModal .close-button').addEventListener('click', () => {
                document.getElementById('duplicateStoresModal').style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target === document.getElementById('duplicateStoresModal')) {
                    document.getElementById('duplicateStoresModal').style.display = 'none';
                }
            });

            // Affected Provinces Modal
            const affectedProvincesCard = document.getElementById('total-affected-provinces-card');
            if (affectedProvincesCard) {
                affectedProvincesCard.addEventListener('click', showAffectedProvincesModal);
            }
            document.querySelector('#affectedProvincesModal .close-button').addEventListener('click', () => {
                document.getElementById('affectedProvincesModal').style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target === document.getElementById('affectedProvincesModal')) {
                    document.getElementById('affectedProvincesModal').style.display = 'none';
                }
            });

            // Affected Regions Modal
            const affectedRegionsCard = document.getElementById('total-affected-regions-card');
            if (affectedRegionsCard) {
                affectedRegionsCard.addEventListener('click', showAffectedRegionsModal);
            }
            document.querySelector('#affectedRegionsModal .close-button').addEventListener('click', () => {
                document.getElementById('affectedRegionsModal').style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target === document.getElementById('affectedRegionsModal')) {
                    document.getElementById('affectedRegionsModal').style.display = 'none';
                }
            });
        });

        // Add Province and Region to parsedCsvData
        parsedCsvData.forEach(row => {
            const locationInfo = storeLocations[row['Store ID']];
            if (locationInfo) {
                row.Province = locationInfo.province;
                row.Region = locationInfo.region;
            } else {
                row.Province = 'ไม่ทราบจังหวัด';
                row.Region = 'ไม่ทราบภาค';
            }
        });

        function populateLocationFilters() {
            const provinceFilter = document.getElementById('provinceFilter');
            const regionFilter = document.getElementById('regionFilter');

            const uniqueProvinces = new Set();
            const uniqueRegions = new Set();

            parsedCsvData.forEach(row => {
                if (row.Province && row.Province !== 'ไม่ทราบจังหวัด') {
                    uniqueProvinces.add(row.Province);
                }
                if (row.Region && row.Region !== 'ไม่ทราบภาค') {
                    uniqueRegions.add(row.Region);
                }
            });

            // Clear existing options before populating
            provinceFilter.innerHTML = '<option value="">จังหวัด: ทั้งหมด</option>';
            regionFilter.innerHTML = '<option value="">ภาค: ทั้งหมด</option>';

            // Populate Province Filter
            Array.from(uniqueProvinces).sort().forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceFilter.appendChild(option);
            });

            // Populate Region Filter
            Array.from(uniqueRegions).sort().forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionFilter.appendChild(option);
            });
        }


        function initializeDashboard() {
            updateDashboard(); // Initial load
        }

        function updateDashboard() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const trueCidFilterTerm = document.getElementById('trueCidFilterInput').value.toLowerCase(); // Get True CID filter term
            const problemTypeFilter = document.getElementById('problemTypeFilter').value;
            const ticketStatusFilter = document.getElementById('ticketStatusFilter').value;
            const remarkStatusFilter = document.getElementById('remarkStatusFilter').value;
            const provinceFilter = document.getElementById('provinceFilter').value;
            const regionFilter = document.getElementById('regionFilter').value;


            // Filter parsedCsvData based on ALL filters
            currentlyDisplayedData = parsedCsvData.filter(row => {
                const rowDate = new Date(row.Date.split('/').reverse().join('-'));
                const start = new Date(startDate);
                const end = new Date(endDate);

                const matchesDate = rowDate >= start && rowDate <= end;

                const matchesSearch = row['Store Name'].toLowerCase().includes(searchTerm) ||
                                      row['Store ID'].includes(searchTerm) ||
                                      row.Ticket.toLowerCase().includes(searchTerm) ||
                                      row.Remark.toLowerCase().includes(searchTerm); // Removed True CID from general search to avoid redundancy

                const matchesTrueCid = trueCidFilterTerm === '' || row['True CID'].toLowerCase().includes(trueCidFilterTerm); // New True CID filter

                const matchesProblemType = problemTypeFilter === '' || row['Problem Type'] === problemTypeFilter;

                const matchesTicketStatus = ticketStatusFilter === '' || 
                                            (ticketStatusFilter === 'hasTicket' && row.Ticket !== '') ||
                                            (ticketStatusFilter === 'noTicket' && row.Ticket === '');

                const matchesRemarkStatus = remarkStatusFilter === '' ||
                                            (remarkStatusFilter === 'hasRemark' && row.Remark !== '') ||
                                            (remarkStatusFilter === 'noRemark' && row.Remark === '');

                const matchesProvince = provinceFilter === '' || row.Province === provinceFilter;
                const matchesRegion = regionFilter === '' || row.Region === regionFilter;

                return matchesDate && matchesSearch && matchesTrueCid && matchesProblemType && matchesTicketStatus && matchesRemarkStatus && matchesProvince && matchesRegion;
            });

            // Re-render all sections with the filtered data
            renderKeyMetrics(currentlyDisplayedData);
            createDailyIncidentsChart(currentlyDisplayedData);
            createProblemTypeChart(currentlyDisplayedData);
            renderDetailsLists(currentlyDisplayedData); // Pass the fully filtered data to details list
        }


        function renderKeyMetrics(data) { // 'data' is currentlyDisplayedData (individual rows)
            // Calculate total unique incidents from the filtered data
            const uniqueIncidents = new Set();
            data.forEach(row => {
                const [day, month, year] = row.Date.split('/');
                const formattedDate = `${year}-${month}-${day}`;
                uniqueIncidents.add(`${formattedDate}-${row.Time}-${row['Problem Type']}`);
            });
            const totalIncidents = uniqueIncidents.size;

            // Calculate total unique affected stores across all incidents within the filtered data
            const allAffectedStoreIds = new Set();
            data.forEach(row => {
                allAffectedStoreIds.add(row['Store ID']);
            });
            const totalAffectedStores = allAffectedStoreIds.size;

            // Calculate unique tickets from filtered data
            const uniqueTickets = new Set();
            data.forEach(row => {
                if (row.Ticket) {
                    uniqueTickets.add(row.Ticket);
                }
            });

            // Calculate unique True CIDs for Main Link and Backup 4G from filtered data
            const uniqueTrueCidsMainLink = new Set();
            const uniqueTrueCidsBackup4G = new Set();
            data.forEach(row => {
                if (row['True CID']) {
                    if (row['Problem Type'] === 'Main Link') {
                        uniqueTrueCidsMainLink.add(row['True CID']);
                    } else if (row['Problem Type'] === 'Backup 4G') {
                        uniqueTrueCidsBackup4G.add(row['True CID']);
                    }
                }
            });

            // Calculate duplicate store IDs (stores that appear more than once in the *filtered* raw data)
            const storeIdCountsFiltered = new Map();
            data.forEach(row => {
                storeIdCountsFiltered.set(row['Store ID'], (storeIdCountsFiltered.get(row['Store ID']) || 0) + 1);
            });
            let duplicateReportedStoreCount = 0;
            for (const [storeId, count] of storeIdCountsFiltered.entries()) {
                if (count > 1) {
                    duplicateReportedStoreCount++;
                }
            }

            // Calculate unique affected provinces
            const affectedProvinces = new Set();
            data.forEach(row => {
                if (row.Province && row.Province !== 'ไม่ทราบจังหวัด') {
                    affectedProvinces.add(row.Province);
                }
            });

            // Calculate unique affected regions
            const affectedRegions = new Set();
            data.forEach(row => {
                if (row.Region && row.Region !== 'ไม่ทราบภาค') {
                    affectedRegions.add(row.Region);
                }
            });
            
            document.getElementById('total-incidents').textContent = totalIncidents;
            document.getElementById('total-affected-stores').textContent = totalAffectedStores;
            document.getElementById('total-tickets').textContent = uniqueTickets.size;
            document.getElementById('total-true-cids-main-link').textContent = uniqueTrueCidsMainLink.size;
            document.getElementById('total-true-cids-backup-4g').textContent = uniqueTrueCidsBackup4G.size;
            document.getElementById('total-duplicate-stores').textContent = duplicateReportedStoreCount;
            document.getElementById('total-affected-provinces').textContent = affectedProvinces.size;
            document.getElementById('total-affected-regions').textContent = affectedRegions.size;
        }

        function createDailyIncidentsChart(data) { // 'data' is currentlyDisplayedData (individual rows)
            const ctx = document.getElementById('dailyIncidentsChart').getContext('2d');
            
            if (window.dailyIncidentsChartInstance) {
                window.dailyIncidentsChartInstance.destroy();
            }

            const dailyCounts = new Map(); // Key: date, Value: { Main Link: count, Backup 4G: count }
            data.forEach(row => {
                const [day, month, year] = row.Date.split('/');
                const formattedDate = `${year}-${month}-${day}`;
                if (!dailyCounts.has(formattedDate)) {
                    dailyCounts.set(formattedDate, { 'Main Link': 0, 'Backup 4G': 0 });
                }
                dailyCounts.get(formattedDate)[row['Problem Type']]++;
            });

            const labels = Array.from(dailyCounts.keys()).sort();
            const mainLinkData = labels.map(label => dailyCounts.get(label)['Main Link']);
            const backup4gData = labels.map(label => dailyCounts.get(label)['Backup 4G']);

            window.dailyIncidentsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(l => new Date(l).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })),
                    datasets: [
                        { label: 'Main Link', data: mainLinkData, backgroundColor: 'rgb(59 130 246)', },
                        { label: 'Backup 4G', data: backup4gData, backgroundColor: 'rgb(217 119 6)', }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (tooltipItems) => `วันที่ ${tooltipItems[0].label}`,
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw + ' ร้านค้า'; // Now counts stores, not incidents
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createProblemTypeChart(data) { // 'data' is currentlyDisplayedData (individual rows)
            const ctx = document.getElementById('problemTypeChart').getContext('2d');

            if (window.problemTypeChartInstance) {
                window.problemTypeChartInstance.destroy();
            }

            const mainLinkStoresCount = data.filter(row => row['Problem Type'] === 'Main Link').length;
            const backup4gStoresCount = data.filter(row => row['Problem Type'] === 'Backup 4G').length;

            window.problemTypeChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Main Link', 'Backup 4G'],
                    datasets: [{
                        label: 'จำนวนร้านค้า',
                        data: [mainLinkStoresCount, backup4gStoresCount],
                        backgroundColor: ['rgb(59 130 246)', 'rgb(217 119 6)'],
                        borderColor: ['#fff'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => ` ${context.label}: ${context.raw} ร้านค้า`
                            }
                        }
                    }
                }
            });
        }
        
        function renderDetailsLists(dataToDisplay) { // 'dataToDisplay' is currentlyDisplayedData (individual rows)
            const mainLinkList = document.getElementById('main-link-list');
            const backup4gList = document.getElementById('backup-4g-list');
            mainLinkList.innerHTML = '';
            backup4gList.innerHTML = '';
            
            let foundResults = false;

            // Re-group dataToDisplay into incidents for rendering
            const groupedFilteredIncidents = new Map();
            dataToDisplay.forEach(row => {
                const [day, month, year] = row.Date.split('/');
                const formattedDate = `${year}-${month}-${day}`;
                const key = `${formattedDate}-${row.Time}-${row['Problem Type']}`;

                if (!groupedFilteredIncidents.has(key)) {
                    groupedFilteredIncidents.set(key, {
                        date: formattedDate,
                        time: row.Time,
                        type: row['Problem Type'],
                        stores: []
                    });
                }
                const incident = groupedFilteredIncidents.get(key);
                incident.stores.push({
                    id: row['Store ID'],
                    name: row['Store Name'],
                    ticket: row.Ticket,
                    trueCid: row['True CID'],
                    remark: row.Remark,
                    province: row.Province, // Add province
                    region: row.Region // Add region
                });
            });

            const sortedGroupedIncidents = Array.from(groupedFilteredIncidents.values()).sort((a, b) => {
                const dateA = new Date(`${a.date}T${a.time}:00`);
                const dateB = new Date(`${b.date}T${b.time}:00`);
                return dateA - dateB;
            });

            if (sortedGroupedIncidents.length === 0) {
                document.getElementById('no-results').style.display = 'block';
                return;
            } else {
                document.getElementById('no-results').style.display = 'none';
            }

            sortedGroupedIncidents.forEach(incident => {
                foundResults = true; // At least one incident found

                const card = document.createElement('div');
                card.className = 'p-4 rounded-lg border bg-slate-50';
                
                const storeListHtml = incident.stores.map(store => `
                    <li class="flex flex-col sm:flex-row sm:justify-between items-start sm:items-center text-sm py-1 border-b border-slate-200 last:border-b-0">
                        <div class="flex-grow">
                            <span class="text-slate-700 font-medium">รหัสสาขา ${store.id} สาขา ${store.name} ${duplicateStoreIdsAllData.has(store.id) ? '<span class="text-xs text-orange-500">(แจ้งซ้ำ)</span>' : ''}</span>
                            ${store.province !== 'ไม่ทราบจังหวัด' ? `<p class="text-xs text-slate-500 mt-1 sm:mt-0">จังหวัด: ${store.province} (${store.region})</p>` : ''}
                            ${store.ticket ? `<p class="text-xs text-slate-500 mt-1 sm:mt-0">Ticket: ${store.ticket}</p>` : ''}
                            ${store.trueCid ? `<p class="text-xs text-slate-500 mt-1 sm:mt-0">True CID: ${store.trueCid}</p>` : ''}
                            ${store.remark ? `<p class="text-xs text-slate-500 mt-1 sm:mt-0">Remark: ${store.remark}</p>` : ''}
                        </div>
                    </li>
                `).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm font-semibold text-slate-600">${new Date(incident.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <p class="text-sm text-slate-500">${incident.time} น.</p>
                    </div>
                    <ul class="space-y-1">${storeListHtml}</ul>
                `;

                if (incident.type === 'Main Link') {
                    card.classList.add('border-blue-200');
                    mainLinkList.appendChild(card);
                } else {
                    card.classList.add('border-amber-200');
                    backup4gList.appendChild(card);
                }
            });
            
            document.getElementById('no-results').style.display = foundResults ? 'none' : 'block';
        }
        
        // This function is now just a wrapper to trigger updateDashboard
        function filterLists(searchTerm) {
             updateDashboard();
        }

        function downloadCsv() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // Add BOM for Thai characters
            csvContent += "Date,Time,Problem Type,Store ID,Store Name,Ticket,True CID,Remark,Province,Region\n"; // Updated headers

            currentlyDisplayedData.forEach(row => { // Use currentlyDisplayedData for direct CSV output
                const rowValues = [
                    row.Date,
                    row.Time,
                    row['Problem Type'],
                    row['Store ID'],
                    `"${row['Store Name'].replace(/"/g, '""')}"`, // Handle commas and quotes
                    `"${row.Ticket.replace(/"/g, '""')}"`,
                    `"${row['True CID'].replace(/"/g, '""')}"`,
                    `"${row.Remark.replace(/"/g, '""')}"`,
                    `"${row.Province.replace(/"/g, '""')}"`,
                    `"${row.Region.replace(/"/g, '""')}"`
                ];
                csvContent += rowValues.join(',') + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "router_incident_report_filtered.csv"); // Changed filename
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showDuplicateStoresModal() {
            const modal = document.getElementById('duplicateStoresModal');
            const list = document.getElementById('duplicate-stores-list');
            list.innerHTML = ''; // Clear previous list

            const duplicateStoresDetails = new Map(); // Store ID -> {name, count}

            // Iterate through the original parsedCsvData to get full counts
            parsedCsvData.forEach(row => {
                if (storeIdCountsAllData.has(row['Store ID']) && storeIdCountsAllData.get(row['Store ID']) > 1) { // Check if it's actually a duplicate
                    if (!duplicateStoresDetails.has(row['Store ID'])) {
                        duplicateStoresDetails.set(row['Store ID'], { name: row['Store Name'], count: 0, problemTypes: new Set(), province: row.Province, region: row.Region });
                    }
                    const detail = duplicateStoresDetails.get(row['Store ID']);
                    detail.count++;
                    detail.problemTypes.add(row['Problem Type']);
                }
            });

            // Sort by count (descending) then by store name
            const sortedDuplicateStores = Array.from(duplicateStoresDetails.entries()).sort((a, b) => {
                if (b[1].count !== a[1].count) {
                    return b[1].count - a[1].count;
                }
                return a[1].name.localeCompare(b[1].name, 'th', { sensitivity: 'base' });
            });

            if (sortedDuplicateStores.length === 0) {
                list.innerHTML = '<li class="text-slate-500">ไม่พบสาขาที่มีการแจ้งซ้ำกันในข้อมูลปัจจุบัน</li>';
            } else {
                sortedDuplicateStores.forEach(([id, details]) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-3 bg-slate-100 rounded-lg border border-slate-200 flex flex-col sm:flex-row sm:justify-between items-start sm:items-center';
                    listItem.innerHTML = `
                        <div class="flex-grow">
                            <span class="font-semibold text-slate-800">รหัสสาขา ${id} สาขา ${details.name}</span>
                            ${details.province !== 'ไม่ทราบจังหวัด' ? `<p class="text-xs text-slate-500 mt-1 sm:mt-0">จังหวัด: ${details.province} (${details.region})</p>` : ''}
                            <p class="text-xs text-slate-500 mt-1 sm:mt-0">แจ้งปัญหา ${details.count} ครั้ง</p>
                            <p class="text-xs text-slate-500">ประเภทปัญหา: ${Array.from(details.problemTypes).join(', ')}</p>
                        </div>
                    `;
                    list.appendChild(listItem);
                });
            }

            modal.style.display = 'flex'; // Use flex to center content
        }

        function showAffectedProvincesModal() {
            const modal = document.getElementById('affectedProvincesModal');
            const list = document.getElementById('affected-provinces-list');
            list.innerHTML = '';

            const affectedProvincesMap = new Map(); // Province -> count of stores

            currentlyDisplayedData.forEach(row => {
                if (row.Province && row.Province !== 'ไม่ทราบจังหวัด') {
                    affectedProvincesMap.set(row.Province, (affectedProvincesMap.get(row.Province) || 0) + 1);
                }
            });

            const sortedProvinces = Array.from(affectedProvincesMap.entries()).sort((a, b) => {
                if (b[1] !== a[1]) {
                    return b[1] - a[1]; // Sort by count descending
                }
                return a[0].localeCompare(b[0], 'th', { sensitivity: 'base' }); // Then by province name
            });

            if (sortedProvinces.length === 0) {
                list.innerHTML = '<li class="text-slate-500">ไม่พบจังหวัดที่ได้รับผลกระทบในข้อมูลที่กรอง</li>';
            } else {
                sortedProvinces.forEach(([province, count]) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-3 bg-slate-100 rounded-lg border border-slate-200 flex justify-between items-center';
                    listItem.innerHTML = `
                        <span class="font-semibold text-slate-800">${province}</span>
                        <span class="text-sm text-slate-600">${count} สาขา</span>
                    `;
                    list.appendChild(listItem);
                });
            }
            modal.style.display = 'flex';
        }

        function showAffectedRegionsModal() {
            const modal = document.getElementById('affectedRegionsModal');
            const list = document.getElementById('affected-regions-list');
            list.innerHTML = '';

            const affectedRegionsMap = new Map(); // Region -> count of stores

            currentlyDisplayedData.forEach(row => {
                if (row.Region && row.Region !== 'ไม่ทราบภาค') {
                    affectedRegionsMap.set(row.Region, (affectedRegionsMap.get(row.Region) || 0) + 1);
                }
            });

            const sortedRegions = Array.from(affectedRegionsMap.entries()).sort((a, b) => {
                if (b[1] !== a[1]) {
                    return b[1] - a[1]; // Sort by count descending
                }
                return a[0].localeCompare(b[0], 'th', { sensitivity: 'base' }); // Then by region name
            });

            if (sortedRegions.length === 0) {
                list.innerHTML = '<li class="text-slate-500">ไม่พบภาคที่ได้รับผลกระทบในข้อมูลที่กรอง</li>';
            } else {
                sortedRegions.forEach(([region, count]) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-3 bg-slate-100 rounded-lg border border-slate-200 flex justify-between items-center';
                    listItem.innerHTML = `
                        <span class="font-semibold text-slate-800">${region}</span>
                        <span class="text-sm text-slate-600">${count} สาขา</span>
                    `;
                    list.appendChild(listItem);
                });
            }
            modal.style.display = 'flex';
        }

    </script>
</body>
</html>
